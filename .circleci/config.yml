version: 2.1

orbs:
  win: circleci/windows@4.1

# ------------------------------------------------
# Configurations
# ------------------------------------------------
flutter_version: &flutter_version
  FLUTTER_VERSION: "2.10.4"
default_flutter_wdir: &default_flutter_wdir
  working_directory: ~/qaul-libp2p/qaul_ui
flutter_ios_dir: &flutter_ios_dir
  working_directory: ~/qaul-libp2p/qaul_ui/ios
checkout_to_root: &checkout_to_root
  steps:
    - checkout:
        path: ~/qaul-libp2p

aliases:
  - &restore_git_cache
    name: Restore GIT cache
    keys:
      - source-v1-{{ .Branch }}-{{ .Revision }}
      - source-v1-{{ .Branch }}-
      - source-v1-
  - &save_git_cache
    name: Save GIT cache
    key: source-v1-{{ .Branch }}-{{ .Revision }}
    paths:
      - .git

executors:
  flutter:
    docker:
      - image: cirrusci/flutter:stable
    <<: *default_flutter_wdir
  android-flutter:
    docker:
      - image: cimg/android:2021.10
    resource_class: large
    <<: *default_flutter_wdir
  android-rust:
    docker:
      - image: cimg/android:2022.03-ndk
    resource_class: large

jobs:
  # ------------------------------------------------
  # Integration Jobs
  # ------------------------------------------------
  flutter-analyze:
    executor: flutter
    steps:
      - restore_cache: *restore_git_cache
      - checkout-project
      - save_cache: *save_git_cache
      - install-flutter-deps
      - run: flutter analyze
  flutter-test:
    executor: flutter
    steps:
      - restore_cache: *restore_git_cache
      - checkout-project
      - save_cache: *save_git_cache
      - install-flutter-deps
      - run: flutter test
  # ------------------------------------------------
  # Deploy Jobs
  # ------------------------------------------------
  publish-github-release:
    working_directory: ~/qaul-libp2p
    docker:
      - image: cibuilds/github:0.13
    steps:
      - restore_cache: *restore_git_cache
      - checkout-project
      - save_cache: *save_git_cache
      - attach_workspace:
          at: ~/qaul-libp2p
      - run:
          name: Copy binaries to ./artifacts
          command: |
            mkdir artifacts
            # Linux
            cp rust/target/release/liblibqaul.so ./artifacts/
            cp rust/target/release/qaul-cli ./artifacts/
            cp rust/target/release/qauld ./artifacts/
            # Android
            cp -a android/blemodule/build/outputs/aar/. ./artifacts/
            cp -a android/libqaul/build/outputs/aar/. ./artifacts/
            # iOS
            cp rust/target/debug/liblibqaul.dylib ./artifacts/
            # MacOS
            cp rust/target/universal/release/liblibqaul.a ./artifacts/
            # Windows
            cp rust/target/debug/libqaul.dll ./artifacts/
      - run:
          name: Publish Release on GitHub
          command: |
            VERSION=$(cd rust/libqaul && cargo pkgid | cut -d# -f2 | cut -d: -f2)
            ghr -t ${GITHUB_TOKEN} -u ${CIRCLE_PROJECT_USERNAME} -r ${CIRCLE_PROJECT_REPONAME} -c ${CIRCLE_SHA1} -delete ${VERSION} ./artifacts/
  # #  ---------------------------------------------
  # #  Rust
  # #  ---------------------------------------------
  # # #  -------------------------------------------
  # # #  (Rust) Linux
  # # #  -------------------------------------------
  build-libqaul-linux:
    docker:
      - image: cimg/rust:1.60.0
    working_directory: ~/qaul-libp2p
    shell: /bin/bash --login -o pipefail
    environment:
      CARGO_NET_GIT_FETCH_WITH_CLI: "true"
    steps:
      - restore_cache: *restore_git_cache
      - checkout-project
      - save_cache: *save_git_cache
      - setup-sccache
      - restore-sccache-cache
      - run:
          name: Build Libqaul for Linux
          command: cd rust && cargo build --release
      - save-sccache-cache
      - persist_to_workspace:
          root: ~/qaul-libp2p
          paths:
            - rust/target/release/liblibqaul.so
            - rust/target/release/qaul-cli
            - rust/target/release/qauld
      - when:
          condition: on_success
          steps:
            - store_artifacts:
                path: rust/target/release/liblibqaul.so
            - store_artifacts:
                path: rust/target/release/qaul-cli
            - store_artifacts:
                path: rust/target/release/qauld
  # # #  -------------------------------------------
  # # #  (Rust) Android
  # # #  -------------------------------------------
  build-libqaul-android:
    executor: android-rust
    working_directory: ~/qaul-libp2p
    shell: /bin/bash --login -o pipefail
    environment:
      ANDROID_NDK_HOME: /home/circleci/android-sdk/ndk/22.1.7171670
      CARGO_NET_GIT_FETCH_WITH_CLI: "true"
    steps:
      - restore_cache: *restore_git_cache
      - checkout-project
      - save_cache: *save_git_cache
      - run:
          name: Install Rust
          command: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
      - setup-sccache
      - restore-sccache-cache
      - run:
          name: Install build targets for android in rust
          command: rustup target add aarch64-linux-android armv7-linux-androideabi i686-linux-android x86_64-linux-android
      - run:
          name: Install Cargo NDK
          command: cd rust/libqaul && cargo install cargo-ndk
      - run:
          name: Build Libqaul JniLibs for Android
          command: cd rust/libqaul && sh build_libqaul_android.sh
      - save-sccache-cache
      - restore_cache:
          key: jars-{{ checksum "android/build.gradle" }}-{{ checksum  "android/libqaul/build.gradle" }}-{{ checksum  "android/blemodule/build.gradle" }}
      - run:
          name: Build AAR Library
          command: cd android && sh gradlew assemble
      - save_cache:
          paths:
            - ~/.gradle
          key: jars-{{ checksum "android/build.gradle" }}-{{ checksum  "android/libqaul/build.gradle" }}-{{ checksum  "android/blemodule/build.gradle" }}
      - persist_to_workspace:
          root: ~/qaul-libp2p
          paths:
            - android/blemodule/build/outputs/aar/blemodule-debug.aar
            - android/libqaul/build/outputs/aar/libqaul-debug.aar
      - when:
          condition: on_success
          steps:
            - store_artifacts:
                path: android/blemodule/build/outputs/aar
            - store_artifacts:
                path: android/libqaul/build/outputs/aar
  # # #  -------------------------------------------
  # # #  (Rust) iOS
  # # #  -------------------------------------------
  build-libqaul-ios:
    macos:
      xcode: 13.0.0
    working_directory: ~/qaul-libp2p
    shell: /bin/bash --login -o pipefail
    environment:
      CARGO_NET_GIT_FETCH_WITH_CLI: "true"
    steps:
      - restore_cache: *restore_git_cache
      - checkout-project
      - save_cache: *save_git_cache
      - run:
          name: Install CMake
          command: brew install cmake
      - run:
          name: Install Rust
          command: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
      - setup-sccache
      - restore-sccache-cache
      - run:
          name: Install build targets for iOS in rust
          command: rustup target add aarch64-apple-ios x86_64-apple-ios
      - run:
          name: Install Cargo Lipo
          command: cd rust/libqaul && cargo install cargo-lipo
      - run:
          name: Build Libqaul *.a Library for iOS
          command: cd rust/libqaul && sh build_libqaul_ios.sh
      - save-sccache-cache
      - persist_to_workspace:
          root: ~/qaul-libp2p
          paths:
              - rust/target/universal/release/liblibqaul.a
      - when:
          condition: on_success
          steps:
            - store_artifacts:
                path: rust/target/universal/release/liblibqaul.a
  # # #  -------------------------------------------
  # # #  (Rust) MacOS
  # # #  -------------------------------------------
  build-libqaul-macos:
    macos:
      xcode: 13.0.0
    working_directory: ~/qaul-libp2p
    shell: /bin/bash --login -o pipefail
    environment:
      CARGO_NET_GIT_FETCH_WITH_CLI: "true"
    steps:
      - restore_cache: *restore_git_cache
      - checkout-project
      - save_cache: *save_git_cache
      - run:
          name: Install CMake
          command: brew install cmake
      - run:
          name: Install Rust
          command: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
      - setup-sccache
      - restore-sccache-cache
      - run:
          name: Build Libqaul *.dylib Library for MacOS
          command: cd rust && cargo build
      - save-sccache-cache
      - persist_to_workspace:
          root: ~/qaul-libp2p
          paths:
              - rust/target/debug/liblibqaul.dylib
      - when:
          condition: on_success
          steps:
            - store_artifacts:
                path: rust/target/debug/liblibqaul.dylib
  # # #  -------------------------------------------
  # # #  (Rust) Windows
  # # #  -------------------------------------------
  build-libqaul-windows:
    executor:
      name: win/default
      size: "medium"
      shell: bash.exe
    working_directory: ~/qaul-libp2p
    environment:
      CARGO_NET_GIT_FETCH_WITH_CLI: "true"
    steps:
      - restore_cache: *restore_git_cache
      - checkout-project
      - save_cache: *save_git_cache
      - run:
          name: Install CMake
          shell: powershell.exe
          command: choco install cmake -y
      - run:
          name: Install Rust
          command: |
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            export PATH="/c/Users/circleci/.cargo/bin:$PATH"
            cargo --version
            rustup --version
            rustc --version
      - run:
          name: Build dll Libqaul
          no_output_timeout: 30m
          command: |
            export PATH="/c/Users/circleci/.cargo/bin:/c/Program Files/CMake/bin:$PATH"
            cd rust && cargo build
      - persist_to_workspace:
          root: ~/qaul-libp2p
          paths:
            - rust/target/debug/libqaul.dll
  # #  ---------------------------------------------
  # #  Flutter
  # #  ---------------------------------------------
  # # #  -------------------------------------------
  # # #  (Flutter) Android
  # # #  -------------------------------------------
  android-beta-deploy:
    executor: android-flutter
    working_directory: ~/qaul-libp2p/qaul_ui/android
    environment:
      FL_OUTPUT_DIR: output
      FASTLANE_LANE: upload_beta_playstore
      LANG: en_US.UTF-8
      LC_ALL: en_US.UTF-8
      _JAVA_OPTIONS: "-Xmx2048m"
      GRADLE_OPTS: '-Dorg.gradle.jvmargs="-Xmx2048m"'
      SUPPLY_JSON_KEY: ~/qaul-libp2p/qaul_ui/android/fastlane/google-credentials.json
      <<: *flutter_version
    shell: /bin/bash --login -o pipefail
    steps:
      - restore_cache: *restore_git_cache
      - checkout-project
      - save_cache: *save_git_cache
      - attach_workspace:
          at: ~/qaul-libp2p
      - run:
          name: Check for presence of AAR Files
          command: |
            if [ ! -f ../../android/libqaul/build/outputs/aar/libqaul-debug.aar ] || [ ! -f ../../android/blemodule/build/outputs/aar/blemodule-debug.aar ]; then
              echo "Libqaul/blemodule AAR file could not be found. That's probably due an error in persisting files to workspace"; exit 1
            fi
      - install-flutter-linux:
          version: "$FLUTTER_VERSION"
      - install-flutter-deps
      - run:
          name: Install Bundler
          command: ruby --version && sudo gem install bundler -N -v "$(grep -A 1 "BUNDLED WITH" Gemfile.lock | tail -n 1)"
      - install-bundler-deps
      - run: echo "$PLAY_STORE_UPLOAD_KEY" | base64 --decode > app/upload-keystore.jks
      - run: echo "$PLAY_STORE_UPLOAD_KEY_INFO" | base64 --decode > key.properties
      - run: echo "$PLAY_STORE_JSON_KEY" | base64 --decode > fastlane/google-credentials.json
      - run:
          name: fastlane
          command: bundle exec fastlane $FASTLANE_LANE
      - store_artifacts:
          path: output
          destination: output
  # # #  -------------------------------------------
  # # #  (Flutter) iOS
  # # #  -------------------------------------------
  ios-beta-deploy:
    macos:
      xcode: 13.0.0
    <<: *flutter_ios_dir
    environment:
      FL_OUTPUT_DIR: output
      FASTLANE_LANE: upload_testflight
      <<: *flutter_version
    shell: /bin/bash --login -o pipefail
    steps:
      - restore_cache: *restore_git_cache
      - checkout-project
      - save_cache: *save_git_cache
      - attach_workspace:
          at: ~/qaul-libp2p
      - run:
          name: Check for presence of *.a Library
          command: |
            if [ ! -f ../../rust/target/universal/release/liblibqaul.a ]; then
              echo "Libqaul *.a file could not be found. That's probably due an error in persisting files to workspace"; exit 1
            fi
      - install-flutter-macos:
          version: "$FLUTTER_VERSION"
      - install-flutter-deps
      - install-bundler-deps
      - install-cocoapods-deps
      - run:
          name: Build Flutter iOS Configuration
          command: flutter build ios --release --no-codesign --config-only
      - run:
          name: fastlane
          command: bundle exec fastlane $FASTLANE_LANE
      - store_artifacts:
          path: output
          destination: output

# ------------------------------------------------
# Workflows
# ------------------------------------------------
workflows:
  flutter-test-analyze:
    jobs:
      - flutter-test
      - flutter-analyze
  flutter-build-and-deploy:
    jobs:
      - flutter-test:
          filters:
            tags:
              only: /^\d+\.\d+\.\d+(\+\d)*-flutter$/
            branches:
              ignore: /.*/
      - flutter-analyze:
          filters:
            tags:
              only: /^\d+\.\d+\.\d+(\+\d)*-flutter$/
            branches:
              ignore: /.*/
      - build-libqaul-android:
          filters:
            tags:
              only: /^\d+\.\d+\.\d+(\+\d)*-flutter$/
            branches:
              ignore: /.*/
      - build-libqaul-ios:
          filters:
            tags:
              only: /^\d+\.\d+\.\d+(\+\d)*-flutter$/
            branches:
              ignore: /.*/
      - android-beta-deploy:
          requires:
            - flutter-test
            - flutter-analyze
            - build-libqaul-android
          filters:
            tags:
              only: /^\d+\.\d+\.\d+(\+\d)*-flutter$/
            branches:
              ignore: /.*/
      - ios-beta-deploy:
          requires:
            - flutter-test
            - flutter-analyze
            - build-libqaul-ios
          filters:
            tags:
              only: /^\d+\.\d+\.\d+(\+\d)*-flutter$/
            branches:
              ignore: /.*/
  rust-build-and-deploy:
    jobs:
      - build-libqaul-linux
#          filters:
#            tags:
#              only: /^\d+\.\d+\.\d+(\+\d)*-rust$/
#            branches:
#              ignore: /.*/
      - build-libqaul-android
#          filters:
#            tags:
#              only: /^\d+\.\d+\.\d+(\+\d)*-rust$/
#            branches:
#              ignore: /.*/
      - build-libqaul-ios
#          filters:
#            tags:
#              only: /^\d+\.\d+\.\d+(\+\d)*-rust$/
#            branches:
#              ignore: /.*/
      - build-libqaul-macos
#          filters:
#            tags:
#              only: /^\d+\.\d+\.\d+(\+\d)*-rust$/
#            branches:
#              ignore: /.*/
      - build-libqaul-windows
#          filters:
#            tags:
#              only: /^\d+\.\d+\.\d+(\+\d)*-rust$/
#            branches:
#              ignore: /.*/
      - publish-github-release:
          requires:
            - build-libqaul-linux
            - build-libqaul-android
            - build-libqaul-ios
            - build-libqaul-macos
            - build-libqaul-windows
#          filters:
#            tags:
#              only: /^\d+\.\d+\.\d+(\+\d)*-rust$/
#            branches:
#              ignore: /.*/

# ------------------------------------------------
# Reusable commands
# ------------------------------------------------
commands:
  checkout-project:
    description: "Invokes the checkout CircleCI step, declaring `path` as the root of the project (defined by `checkout_to_project_root` anchor)"
    <<: *checkout_to_root


  # ------------------------------------------------
  # Flutter-related commands
  # ------------------------------------------------
  install-flutter-deps:
    description: "Install Flutter dependencies"
    parameters:
      pub-cache:
        type: string
        default: "~/.pub-cache"
      dart-tool-cache:
        type: string
        default: ".dart_tool"
    steps:
      - run: flutter doctor --verbose
      - run:
          name: "Prepare For Cache Key"
          command: |
            cat "$(find .. -iname "pubspec.lock" | head -n 1)" > pubspec.rev
      - restore_cache:
          name: Restore Flutter pub cache
          key: pub-cache-v3-{{ arch }}-{{ .Environment.CIRCLE_WORKING_DIRECTORY }}-{{ checksum "pubspec.rev" }}
      - run:
          name: Install Flutter Dependencies
          command: flutter pub get
      - save_cache:
          name: Save Flutter pub cache
          key: pub-cache-v3-{{ arch }}-{{ .Environment.CIRCLE_WORKING_DIRECTORY }}-{{ checksum "pubspec.rev" }}
          paths:
            - << parameters.dart-tool-cache >>
            - << parameters.pub-cache >>

  install-bundler-deps:
    description: "Install Bundle dependencies"
    steps:
      - restore_cache:
          name: Restore Bundle cache
          keys:
            - gem-cache-v2-{{ arch }}-{{ checksum "Gemfile.lock" }}
            - gem-cache-v2-{{ arch }}-
      - run:
          name: Install Bundle
          command: bundle check || sudo bundle install --path vendor/bundle
      - save_cache:
          name: Save Bundle cache
          key: gem-cache-v2-{{ arch }}-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle


  # #  ---------------------------------------------
  # #  (Flutter) Android-related commands
  # #  ---------------------------------------------
  install-flutter-linux:
    description: "Installs the Linux flutter binary"
    parameters:
      version:
        type: string
    steps:
      - run:
          name: Install Flutter
          command: |
            cd && mkdir .flutter-sdk
            cd .flutter-sdk
            curl --fail --remote-time --silent --location -O https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_<< parameters.version >>-stable.tar.xz
            tar xf flutter_linux_<< parameters.version >>-stable.tar.xz --strip-components=1
            rm flutter_linux_<< parameters.version >>-stable.tar.xz
            echo "export PATH=$PATH:`pwd`/bin" >> $BASH_ENV


  # #  ---------------------------------------------
  # #  (Flutter) iOS-related commands
  # #  ---------------------------------------------
  install-flutter-macos:
    description: "Installs the MacOS flutter binary"
    parameters:
      version:
        type: string
    steps:
      - run:
          name: Install Flutter
          command: |
            cd && mkdir .flutter-sdk
            cd .flutter-sdk
            curl --fail --remote-time --silent --location -O https://storage.googleapis.com/flutter_infra_release/releases/stable/macos/flutter_macos_<< parameters.version >>-stable.zip
            unzip flutter_macos_<< parameters.version >>-stable.zip
            rm flutter_macos_<< parameters.version >>-stable.zip
            echo "export PATH=$PATH:`pwd`/flutter/bin" >> $BASH_ENV

  install-cocoapods-deps:
    description: "Install Pods dependencies"
    steps:
      - restore_cache:
          name: Restore CocoaPods cache
          key: pods-cache-v1-{{ arch }}-{{ checksum "Podfile.lock" }}
      - run:
          name: Install CocoaPods
          command: pod install
      - save_cache:
          name: Save CocoaPods cache
          key: pods-cache-v1-{{ arch }}-{{ checksum "Podfile.lock" }}
          paths:
            - ./Pods


  # ------------------------------------------------
  # Rust-related commands
  # ------------------------------------------------
  setup-sccache:
    description: "Installs and configures sccache as a wrapper for rustc"
    steps:
      - run:
          name: Install sccache
          command: |
            cargo install sccache
            # This configures Rust to use sccache.
            echo 'export "RUSTC_WRAPPER"="sccache"' >> $BASH_ENV
            # This is the maximum space sccache cache will use on disk.
            echo 'export "SCCACHE_CACHE_SIZE"="1G"' >> $BASH_ENV
            sccache --version
  restore-sccache-cache:
    steps:
      - restore_cache:
          name: Restore sccache cache
          key: sccache-cache-stable-{{ arch }}-{{ .Environment.CIRCLE_JOB }}
  save-sccache-cache:
    steps:
      - save_cache:
          name: Save sccache cache
          # We use {{ epoch }} to always upload a fresh cache:
          # Of course, restore_cache will not find this exact key,
          # but it will fall back to the closest key (aka the most recent).
          # See https://discuss.circleci.com/t/add-mechanism-to-update-existing-cache-key/9014/13
          key: sccache-cache-stable-{{ arch }}-{{ .Environment.CIRCLE_JOB }}-{{ epoch }}
          paths:
            - "~/.cache/sccache"